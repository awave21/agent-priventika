#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è CRM —Å–∏—Å—Ç–µ–º—ã
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./deploy.sh [–ª–æ–∫–∞–ª—å–Ω—ã–π|–ø—Ä–æ–¥–∞–∫—à–Ω]

set -e

echo "üöÄ –ù–∞—á–∏–Ω–∞–µ–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ CRM —Å–∏—Å—Ç–µ–º—ã..."

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–∂–∏–º —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
MODE=${1:-–ª–æ–∫–∞–ª—å–Ω—ã–π}

case $MODE in
    "–ª–æ–∫–∞–ª—å–Ω—ã–π")
        echo "üìã –†–µ–∂–∏–º: –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ"
        DEPLOY_PATH="/var/www/html"
        ;;
    "–ø—Ä–æ–¥–∞–∫—à–Ω")
        echo "üìã –†–µ–∂–∏–º: –ü—Ä–æ–¥–∞–∫—à–Ω —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ"
        DEPLOY_PATH="/var/www/html"
        ;;
    *)
        echo "‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ä–µ–∂–∏–º: $MODE"
        echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 [–ª–æ–∫–∞–ª—å–Ω—ã–π|–ø—Ä–æ–¥–∞–∫—à–Ω]"
        exit 1
        ;;
esac

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
if ! command -v npm &> /dev/null; then
    echo "‚ùå npm –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

if ! command -v curl &> /dev/null; then
    echo "‚ùå curl –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
    exit 1
fi

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π –ø—Ä–æ–µ–∫—Ç–∞
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
npm install

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ TypeScript..."
npm run typecheck

# –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
echo "üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞..."
npm run build

# –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ (–µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
if [ -d "$DEPLOY_PATH" ]; then
    echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
    BACKUP_NAME="backup_$(date +%Y%m%d_%H%M%S)"
    cp -r "$DEPLOY_PATH" "/tmp/$BACKUP_NAME"
    echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: /tmp/$BACKUP_NAME"
fi

# –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
echo "üì§ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤..."
if [ "$MODE" = "–ª–æ–∫–∞–ª—å–Ω—ã–π" ]; then
    # –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
    mkdir -p "$DEPLOY_PATH"
    cp -r dist/* "$DEPLOY_PATH/"
else
    # –ü—Ä–æ–¥–∞–∫—à–Ω —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ
    sudo cp -r dist/* "$DEPLOY_PATH/"
    sudo chown -R www-data:www-data "$DEPLOY_PATH"
    sudo chmod -R 755 "$DEPLOY_PATH"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è
echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è..."
if curl -I "http://localhost" >/dev/null 2>&1; then
    echo "‚úÖ –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç"
else
    echo "‚ö†Ô∏è  –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–æ —Ñ–∞–π–ª—ã —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω—ã"
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–µ–Ω–∞ (–µ—Å–ª–∏ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω —Ä–µ–∂–∏–º–µ)
if [ "$MODE" = "–ø—Ä–æ–¥–∞–∫—à–Ω" ]; then
    echo "üåê –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–µ–Ω–∞ agent.integration-ai.ru..."
    if curl -I "https://agent.integration-ai.ru" >/dev/null 2>&1; then
        echo "‚úÖ –î–æ–º–µ–Ω –¥–æ—Å—Ç—É–ø–µ–Ω"
    else
        echo "‚ùå –î–æ–º–µ–Ω –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
        echo "üí° –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–µ—Ä–≤–µ—Ä–∞ –∏ DNS"
    fi
fi

echo ""
echo "üéâ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!"
echo ""
echo "üìã –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:"
echo "1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏"
echo "2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–±–æ—Ç—É –≤–µ–±—Ö—É–∫–æ–≤ Wazzup"
echo "3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Laravel backend —Ä–∞–±–æ—Ç–∞–µ—Ç"
echo ""
echo "üìñ –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:"
echo "   - PROJECT_README.md - –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è"
echo "   - DEPLOYMENT_GUIDE.md - –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é"
echo "   - QUICK_CHECK.md - —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å"
echo ""
echo "üîß –ë—ã—Å—Ç—Ä—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   npm run dev     - –∑–∞–ø—É—Å–∫ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏"
echo "   npm run build   - —Å–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞"
echo "   npm run preview - –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä"
echo "   sudo systemctl status nginx - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞"

if [ -f "/tmp/$BACKUP_NAME" ]; then
    echo ""
    echo "üí° –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è: /tmp/$BACKUP_NAME"
fi